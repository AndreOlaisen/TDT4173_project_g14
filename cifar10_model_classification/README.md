# PyTorch model for CIFAR-10 image classification

This directory contains code for training a PyTorch model to classify images in the CIFAR-10 dataset, as well as code for converting a trained model to a CMSIS-NN implementation.

## Requirements

* Python (required packages listed below)


## Setup

1. Install Python dependencies:
    * `pip install torch torchvision`
2. Make sure that the cmsisnn/cfile submodule is cloned:
    * `git submodule init`
    * `git submodule update`

## Training the PyTorch model

To train the PyTorch model on the CIFAR-10 dataset, run:

```
python cifar10.py --train [--model modelname] [--cleantrain]
```

The `--model` argument is used to select a model from `model.py` to use for training, and defaults to `Model_1`.
The `--cleantrain` argument can be used to remove the checkpoint directory before training the model. By default the checkpoint directory stores the last model trained so that training can be resumed.

This command will output model training statistics as well as a graph displaying the loss and accuracy during training.

## Exporting the model architecture and statistics

Before the PyTorch model can be converted to a CMSIS-NN implementation, the model must be stored along with evaluation statistics on the dataset. This must be done after training. The model and statistics can be exported by running:

```
python cifar10.py --export [--model modelname] [--name name]
```

The `--model` argument is used to select the model to export, and defaults to `Model_1`. The model should match the name of the previously trained model.
The `--name` argument is used as the base of the filenames for the exported model. By default, the model name is used.

This command generates output in `exports/model`.

## Converting the exported model to CMSIS-NN

Once a trained model has been exported, the CMSIS-NN model can be generated by running:

```
python cifar10.py --convert [--model modelname] [--name name]
```

The `--name` and `--model` arguments have similar functionality to the above commands. The script will look for an exported model in `exports/model`.

The generated code is written to `../cmsis_nn/generated/model`. Additionally, a JSON representation of the generated code is dumped to `exports/convert` for debug purposes.

## Building and testing the CMSIS-NN model

The `cifar10.py` script additionally supports building and evaluating the CMSIS-NN model.
Before doing so, make sure that the `../cmsis_nn` directory is set up as detailed in the [README](../cmsis_nn/README.md). The following command builds the PC (host) code using CMake/GCC:

```
python cifar10.py --build [--cleanbuild]
```

The `--cleanbuild` argument removes the `build` directory before building, performing a full rebuild.

To evaluate the accuracy of the generated model on a set of images, the following command can be run:
```
python cifar10.py --eval path1 [path2 ... pathN]
```

Each `path` provided can be to a 32x32 CIFAR-10 .png image file or to a directory containing such files. If the path is a directory, all the image files within the directory are evaluated.
